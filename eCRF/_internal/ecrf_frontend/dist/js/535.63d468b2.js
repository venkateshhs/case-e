"use strict";(self["webpackChunkecrf_frontend"]=self["webpackChunkecrf_frontend"]||[]).push([[535],{531:function(t,e,s){var i=s(6518),r=s(9565),n=s(9306),a=s(8551),o=s(1767),l=s(8646),d=s(9462),c=s(9539),u=s(6395),h=s(684),p=s(4549),g=!u&&!h("flatMap",function(){}),f=!u&&!g&&p("flatMap",TypeError),y=u||g||f,v=d(function(){var t,e,s=this.iterator,i=this.mapper;while(1){if(e=this.inner)try{if(t=a(r(e.next,e.iterator)),!t.done)return t.value;this.inner=null}catch(n){c(s,"throw",n)}if(t=a(r(this.next,s)),this.done=!!t.done)return;try{this.inner=l(i(t.value,this.counter++),!1)}catch(n){c(s,"throw",n)}}});i({target:"Iterator",proto:!0,real:!0,forced:y},{flatMap:function(t){a(this);try{n(t)}catch(e){c(this,"throw",e)}return f?r(f,this,t):new v(o(this),{mapper:t,inner:null})}})},8535:function(t,e,s){s.r(e),s.d(e,{default:function(){return X}});var i=s(641),r=s(33),n=s(3751);const a={key:0,class:"study-dashboard-container"},o={class:"dashboard-header-controls"},l={class:"dashboard-title"},d={class:"version-dropdown"},c=["value"],u={class:"legend-dropdown"},h={class:"export-dropdown"},p={class:"table-controls"},g={class:"left"},f={key:0,class:"view-all"},y={key:0,class:"right"},v={class:"table-wrapper"},b={key:0,class:"loading"},m={key:1,class:"dashboard-table"},k=["colspan"],w=["onClick"],C={class:"filter-row"},L=["onUpdate:modelValue","placeholder"],E={key:2,class:"pagination-controls"},A=["disabled"],x=["disabled"],_=["disabled"],j=["disabled"],S={key:0,class:"no-data"},I={key:1,class:"loading"};function V(t,e,s,V,P,$){return P.study?((0,i.uX)(),(0,i.CE)("div",a,[(0,i.Lk)("div",o,[(0,i.Lk)("button",{class:"btn-minimal",onClick:e[0]||(e[0]=(...t)=>$.goBack&&$.goBack(...t))}," Back "),(0,i.Lk)("h2",l,(0,r.v_)(P.study.metadata.study_name),1),(0,i.Lk)("div",d,[e[18]||(e[18]=(0,i.Lk)("label",{for:"version-select"},"Version:",-1)),(0,i.bo)((0,i.Lk)("select",{id:"version-select","onUpdate:modelValue":e[1]||(e[1]=t=>P.selectedVersion=t)},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(P.studyVersions,t=>((0,i.uX)(),(0,i.CE)("option",{key:"ver-"+t.version,value:t.version},(0,r.v_)(t.version),9,c))),128))],512),[[n.u1,P.selectedVersion,void 0,{number:!0}]])]),(0,i.Lk)("div",u,[(0,i.Lk)("button",{class:"btn-minimal icon-only",onClick:e[2]||(e[2]=t=>P.showLegend=!P.showLegend),title:"Table Legend"},[(0,i.Lk)("i",{class:(0,r.C4)(P.icons.info)},null,2)]),P.showLegend?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"legend-content",onClick:e[3]||(e[3]=(0,n.D$)(()=>{},["stop"]))},[...e[19]||(e[19]=[(0,i.Fv)('<p data-v-670e0aad><span class="legend-swatch swatch-gray" data-v-670e0aad></span><strong data-v-670e0aad>Gray cell:</strong> No section assigned for this subject’s group at this visit. </p><p data-v-670e0aad><span class="legend-swatch swatch-none" data-v-670e0aad></span><strong data-v-670e0aad>No color:</strong> Section assigned but no data has been entered. </p><p data-v-670e0aad><span class="legend-swatch swatch-red" data-v-670e0aad></span><strong data-v-670e0aad>Red cell:</strong> Required field was <em data-v-670e0aad>skipped</em> when saving. </p><p data-v-670e0aad>Data is displayed for each subject under the visit and section assigned to their group.</p>',4)])])):(0,i.Q3)("",!0)]),(0,i.Lk)("div",h,[(0,i.Lk)("button",{class:"btn-minimal",onClick:e[4]||(e[4]=(0,n.D$)((...t)=>$.toggleExportMenu&&$.toggleExportMenu(...t),["stop"]))},[e[20]||(e[20]=(0,i.eW)(" Export ",-1)),(0,i.Lk)("i",{class:(0,r.C4)(P.icons.export)},null,2)]),P.showExportMenu?((0,i.uX)(),(0,i.CE)("div",{key:0,class:"export-menu",onClick:e[7]||(e[7]=(0,n.D$)(()=>{},["stop"]))},[(0,i.Lk)("button",{onClick:e[5]||(e[5]=(...t)=>$.exportCSV&&$.exportCSV(...t))},"Download CSV"),(0,i.Lk)("button",{onClick:e[6]||(e[6]=(...t)=>$.exportExcel&&$.exportExcel(...t))},"Download Excel")])):(0,i.Q3)("",!0)])]),(0,i.Lk)("div",p,[(0,i.Lk)("div",g,[(0,i.Lk)("span",null,"Total rows: "+(0,r.v_)($.totalGridRows),1),$.canViewAll?((0,i.uX)(),(0,i.CE)("label",f,[(0,i.bo)((0,i.Lk)("input",{type:"checkbox","onUpdate:modelValue":e[8]||(e[8]=t=>P.viewAll=t)},null,512),[[n.lH,P.viewAll]]),(0,i.eW)(" View all (≤ "+(0,r.v_)(P.VIEW_ALL_MAX_ROWS)+") ",1)])):(0,i.Q3)("",!0)]),P.viewAll?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",y,[e[22]||(e[22]=(0,i.Lk)("label",{for:"page-size"},"Rows per page:",-1)),(0,i.bo)((0,i.Lk)("select",{id:"page-size","onUpdate:modelValue":e[9]||(e[9]=t=>P.pageSize=t)},[...e[21]||(e[21]=[(0,i.Lk)("option",{value:50},"50",-1),(0,i.Lk)("option",{value:100},"100",-1)])],512),[[n.u1,P.pageSize,void 0,{number:!0}]])]))]),(0,i.Lk)("div",v,[P.isLoadingEntries?((0,i.uX)(),(0,i.CE)("div",b,"Building dashboard…")):((0,i.uX)(),(0,i.CE)("table",m,[(0,i.Lk)("thead",null,[(0,i.Lk)("tr",null,[(0,i.Lk)("th",{rowspan:"2",onClick:e[10]||(e[10]=t=>$.sortTable("subjectId"))},[e[23]||(e[23]=(0,i.eW)(" Subject ID ",-1)),(0,i.Lk)("i",{class:(0,r.C4)($.sortIcon("subjectId"))},null,2)]),(0,i.Lk)("th",{rowspan:"2",onClick:e[11]||(e[11]=t=>$.sortTable("visit"))},[e[24]||(e[24]=(0,i.eW)(" Visit ",-1)),(0,i.Lk)("i",{class:(0,r.C4)($.sortIcon("visit"))},null,2)]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)($.sections,(t,e)=>((0,i.uX)(),(0,i.CE)("th",{key:"hdr-sec-"+e,colspan:$.fieldsPerSection[e]},(0,r.v_)(t.title),9,k))),128))]),(0,i.Lk)("tr",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)($.sections,(t,e)=>((0,i.uX)(),(0,i.CE)(i.FK,{key:"hdr-fld-"+e},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(t.fields,(t,s)=>((0,i.uX)(),(0,i.CE)("th",{key:"hdr-fld-"+e+"-"+s,onClick:t=>$.sortTable(`s${e}_f${s}`)},[(0,i.eW)((0,r.v_)(t.label||t.name||t.title||`Field ${s+1}`)+" ",1),(0,i.Lk)("i",{class:(0,r.C4)($.sortIcon(`s${e}_f${s}`))},null,2)],8,w))),128))],64))),128))]),(0,i.Lk)("tr",C,[(0,i.Lk)("th",null,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":e[12]||(e[12]=t=>P.filters.subjectId=t),placeholder:"Filter Subject ID"},null,512),[[n.Jo,P.filters.subjectId]])]),(0,i.Lk)("th",null,[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":e[13]||(e[13]=t=>P.filters.visit=t),placeholder:"Filter Visit"},null,512),[[n.Jo,P.filters.visit]])]),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)($.sections,(t,e)=>((0,i.uX)(),(0,i.CE)(i.FK,{key:"filter-sec-"+e},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(t.fields,(t,s)=>((0,i.uX)(),(0,i.CE)("th",{key:"filter-fld-"+e+"-"+s},[(0,i.bo)((0,i.Lk)("input",{"onUpdate:modelValue":t=>P.filters[`s${e}_f${s}`]=t,placeholder:`Filter ${t.label||t.name||t.title||s+1}`},null,8,L),[[n.Jo,P.filters[`s${e}_f${s}`]]])]))),128))],64))),128))])]),(0,i.Lk)("tbody",null,[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)($.paginatedData,(t,e)=>((0,i.uX)(),(0,i.CE)("tr",{key:"row-"+e},[(0,i.Lk)("td",null,(0,r.v_)(t.subjectId),1),(0,i.Lk)("td",null,(0,r.v_)(t.visit),1),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)($.sections,(s,n)=>((0,i.uX)(),(0,i.CE)(i.FK,{key:"row-sec-"+e+"-s"+n},[((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(s.fields,(s,a)=>((0,i.uX)(),(0,i.CE)("td",{key:"cell-"+e+"-s"+n+"-f"+a,class:(0,r.C4)($.cellClass(t.__sIdx,t.__vIdx,n,a))},(0,r.v_)(t[`s${n}_f${a}`]),3))),128))],64))),128))]))),128))])])),P.viewAll||P.isLoadingEntries?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",E,[(0,i.Lk)("button",{disabled:1===P.currentPage,onClick:e[14]||(e[14]=(...t)=>$.goFirst&&$.goFirst(...t))},"First",8,A),(0,i.Lk)("button",{disabled:1===P.currentPage,onClick:e[15]||(e[15]=(...t)=>$.goPrev&&$.goPrev(...t))},"Previous",8,x),(0,i.Lk)("span",null,"Page "+(0,r.v_)(P.currentPage)+" of "+(0,r.v_)($.totalPages),1),(0,i.Lk)("button",{disabled:P.currentPage===$.totalPages,onClick:e[16]||(e[16]=(...t)=>$.goNext&&$.goNext(...t))},"Next",8,_),(0,i.Lk)("button",{disabled:P.currentPage===$.totalPages,onClick:e[17]||(e[17]=(...t)=>$.goLast&&$.goLast(...t))},"Last",8,j)]))]),$.filteredData.length||P.isLoadingEntries?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.CE)("div",S," No data entries found. Please enter data for the assigned sections using the data entry form. "))])):((0,i.uX)(),(0,i.CE)("div",I," Loading study data… "))}s(4114),s(8111),s(2489),s(116),s(531),s(7588),s(1701),s(2404),s(8004),s(3853),s(5876),s(2475),s(5024),s(1698),s(4603),s(7566),s(8721);var P=s(4335),$=s(4678),F={name:"StudyDataDashboard",data(){return{study:null,entries:[],totalEntries:0,showExportMenu:!1,showLegend:!1,token:this.$store.state.token,icons:$.A,sortConfig:{key:"subjectId",direction:"asc"},filters:{subjectId:"",visit:""},currentPage:1,pageSize:50,VIEW_ALL_MAX_ROWS:1e3,viewAll:!1,isLoadingEntries:!1,studyVersions:[],selectedVersion:null,templateCache:new Map,debugOnce:{study:!1,fetch:!1,entryShape:!1}}},computed:{visits(){return this.study?.content?.study_data?.visits||[]},sections(){return this.study?.content?.study_data?.selectedModels||[]},subjects(){return this.study?.content?.study_data?.subjects||[]},fieldsPerSection(){return this.sections.map(t=>t.fields?.length||0)},totalGridRows(){return(this.subjects?.length||0)*(this.visits?.length||0)},canViewAll(){return this.totalGridRows>0&&this.totalGridRows<=this.VIEW_ALL_MAX_ROWS},filteredData(){let t=[];const{subjectIdxPageSet:e,visitIdxPageSet:s}=this.currentWindowIndexSets();if(this.subjects.forEach((i,r)=>{if(!e.has(r))return;const n=this.resolveGroup(r);this.visits.forEach((e,a)=>{if(!s.has(a))return;const o={subjectId:i.id,visit:e.name,__sIdx:r,__vIdx:a};this.sections.forEach((t,e)=>{const s=this.isAssigned(e,a,n);t.fields.forEach((t,i)=>{let n="";if(s){const s=this.getValue(r,a,e,i),o=(t.type||"").toLowerCase();n="checkbox"===o?!0===s?"Yes":!1===s?"No":"":"file"===o?this.formatFileCell(s):null==s||""===s?"":s}o[`s${e}_f${i}`]=n})}),t.push(o)})}),t=t.filter(t=>{if(this.filters.subjectId&&!String(t.subjectId).toLowerCase().includes(this.filters.subjectId.toLowerCase()))return!1;if(this.filters.visit&&!String(t.visit).toLowerCase().includes(this.filters.visit.toLowerCase()))return!1;for(const e in this.filters){if("subjectId"===e||"visit"===e)continue;const s=this.filters[e];if(s&&!String(t[e]??"").toLowerCase().includes(String(s).toLowerCase()))return!1}return!0}),this.sortConfig.key){const e=this.sortConfig.key,s="asc"===this.sortConfig.direction?1:-1;t.sort((t,i)=>{let r=t[e]??"",n=i[e]??"";return r=String(r).toLowerCase(),n=String(n).toLowerCase(),r<n?-1*s:r>n?1*s:0})}return t},totalPages(){if(this.viewAll)return 1;const t=Math.ceil(this.totalGridRows/this.pageSize);return Math.max(1,t)},paginatedData(){return this.filteredData}},watch:{pageSize(){this.viewAll||(this.currentPage=1,this.fetchPageEntries())},currentPage(){this.viewAll||this.fetchPageEntries()},viewAll(){this.currentPage=1,this.fetchPageEntries()},filters:{handler(){this.viewAll||this.fetchPageEntries()},deep:!0},selectedVersion:{async handler(){this.study&&(await this.loadTemplateForSelectedVersion(),this.initDynamicFilters(),this.currentPage=1,await this.fetchPageEntries())}}},async created(){await this.bootstrap()},methods:{dbg(...t){console.log("[Dashboard]",...t)},groupDbg(t,e){console.groupCollapsed("[Dashboard]",t),console.log(e),console.groupEnd()},normalizeKey(t){return String(t||"").trim().toLowerCase()},listKeys(t){return Object.keys(t||{})},sectionDictKey(t){return t?.title??""},fieldDictKey(t,e){return t?.name??t?.key??t?.id??t?.label??t?.title??`f${e}`},dictRead(t,e,s){if(!t||"object"!==typeof t||Array.isArray(t))return;const i=this.sections[e],r=i?.fields?.[s],n=this.sectionDictKey(i),a=this.fieldDictKey(r,s);let o=t[n];if(!o){const e=this.normalizeKey(n),s=Object.keys(t).find(t=>this.normalizeKey(t)===e);s&&(o=t[s],this.dbg("Section key fallback used:",{expected:n,matched:s}))}if(!o||"object"!==typeof o)return void this.dbg("dictRead: section not found",{sIdx:e,sKey:n,available:this.listKeys(t)});if(Object.prototype.hasOwnProperty.call(o,a))return o[a];const l=this.normalizeKey(a),d=Object.keys(o).find(t=>this.normalizeKey(t)===l);if(d)return this.dbg("Field key fallback used:",{sKey:n,expectedField:a,matchedField:d}),o[d];this.dbg("dictRead: field not found",{sIdx:e,fIdx:s,sKey:n,fKey:a,availableFields:this.listKeys(o)})},async bootstrap(){const t=this.$route.params.id;try{const e=await P.A.get(`/forms/studies/${t}`,{headers:{Authorization:`Bearer ${this.token}`}});this.study=e.data,await this.loadVersions(t),!this.selectedVersion&&this.studyVersions.length&&(this.selectedVersion=this.studyVersions[this.studyVersions.length-1].version),await this.loadTemplateForSelectedVersion(),this.debugOnce.study||(this.debugOnce.study=!0,this.groupDbg("Study loaded",{studyId:t,subjects:this.subjects.length,visits:this.visits.length,sections:this.sections.map((t,e)=>({i:e,title:t.title,fieldKeys:(t.fields||[]).map((t,e)=>this.fieldDictKey(t,e))})),assignmentsShape:{m:this.sections.length,v:this.visits.length,g:(this.study?.content?.study_data?.groups||[]).length}})),this.initDynamicFilters(),this.canViewAll&&(this.viewAll=!1),await this.fetchPageEntries()}catch(e){console.error("Failed to load dashboard data:",e),e.response&&401===e.response.status?this.$router.push({name:"Login"}):alert("Could not load study data")}},initDynamicFilters(){const t={subjectId:this.filters.subjectId||"",visit:this.filters.visit||""},e={...t};this.sections.forEach((t,s)=>{t.fields.forEach((t,i)=>{const r=`s${s}_f${i}`;e[r]=this.filters[r]||""})}),this.filters=e},async loadVersions(t){try{const e=await P.A.get(`/forms/studies/${t}/versions`,{headers:{Authorization:`Bearer ${this.token}`}}),s=Array.isArray(e.data)?e.data:[];this.studyVersions=s.sort((t,e)=>t.version-e.version)}catch(e){this.studyVersions=[{version:1}]}},async loadTemplateForSelectedVersion(){const t=this.$route.params.id;if(t&&this.selectedVersion){if(this.templateCache.has(this.selectedVersion)){const t=this.templateCache.get(this.selectedVersion);return void this.applyTemplateSchema(t)}try{const e=await P.A.get(`/forms/studies/${t}/template`,{headers:{Authorization:`Bearer ${this.token}`},params:{version:this.selectedVersion}}),s=e?.data?.schema||{};this.templateCache.set(this.selectedVersion,s),this.applyTemplateSchema(s)}catch(e){}}},applyTemplateSchema(t){const e=this.study?.content?.study_data||{},s={study:t?.study??e.study??{},subjects:Array.isArray(t?.subjects)&&t.subjects.length?t.subjects:e.subjects||[],subjectCount:Number.isFinite(t?.subjectCount)?t.subjectCount:e.subjectCount??(e.subjects?.length||0),visits:Array.isArray(t?.visits)&&t.visits.length?t.visits:e.visits||[],groups:Array.isArray(t?.groups)&&t.groups.length?t.groups:e.groups||[],selectedModels:Array.isArray(t?.selectedModels)?t.selectedModels:e.selectedModels||[],assignments:Array.isArray(t?.assignments)?t.assignments:e.assignments||[]};this.study?this.study.content?this.study.content.study_data=s:this.study.content={study_data:s}:this.study={metadata:{},content:{study_data:s}}},currentWindowIndexSets(){const t=this.subjects.length,e=this.visits.length;if(this.viewAll||0===t||0===e)return{subjectIdxPageSet:new Set([...Array(t).keys()]),visitIdxPageSet:new Set([...Array(e).keys()]),totalRowsInWindow:t*e};const s=(this.currentPage-1)*this.pageSize,i=Math.min(s+this.pageSize,t*e),r=new Set,n=new Set;for(let a=s;a<i;a++){const t=Math.floor(a/e),s=a%e;r.add(t),n.add(s)}return{subjectIdxPageSet:r,visitIdxPageSet:n,totalRowsInWindow:i-s}},async fetchPageEntries(){if(!this.study)return;const t=this.$route.params.id,{subjectIdxPageSet:e,visitIdxPageSet:s}=this.currentWindowIndexSets(),i=this.viewAll?null:Array.from(e).sort((t,e)=>t-e).join(","),r=this.viewAll?null:Array.from(s).sort((t,e)=>t-e).join(","),n=new URLSearchParams;this.viewAll&&n.append("all","true"),i&&n.append("subject_indexes",i),r&&n.append("visit_indexes",r),Number.isFinite(this.selectedVersion)&&n.append("version",String(this.selectedVersion));const a=`/forms/studies/${t}/data_entries`+(n.toString()?`?${n.toString()}`:"");try{this.isLoadingEntries=!0,this.debugOnce.fetch||(this.debugOnce.fetch=!0,this.dbg("Fetching entries…",{url:a,viewAll:this.viewAll,subject_indexes:i,visit_indexes:r,version:this.selectedVersion}));const t=await P.A.get(a,{headers:{Authorization:`Bearer ${this.token}`}}),e=Array.isArray(t.data)?{entries:t.data,total:t.data.length}:t.data||{};if(this.entries=e.entries||[],this.totalEntries=e.total??this.entries.length,!this.debugOnce.entryShape){this.debugOnce.entryShape=!0;const t=(this.entries||[]).slice(0,3).map(t=>({id:t.id,s:t.subject_index,v:t.visit_index,g:t.group_index,dataType:Array.isArray(t.data)?"array":t.data&&"object"===typeof t.data?"dict":typeof t.data,topKeys:t.data&&"object"===typeof t.data&&!Array.isArray(t.data)?Object.keys(t.data):null}));this.groupDbg("Entries fetched",{count:this.entries.length,sample:t}),t[0]?.topKeys&&this.dbg("First entry dict section keys:",t[0].topKeys)}}catch(o){console.error("Failed to load entries:",o),this.entries=[]}finally{this.isLoadingEntries=!1}},goBack(){const t=this.$route.params.id;this.$router.push({name:"StudyView",params:{id:t}})},toggleExportMenu(){this.showExportMenu=!this.showExportMenu},resolveGroup(t){const e=(this.subjects[t]?.group||"").trim().toLowerCase(),s=this.study?.content?.study_data?.groups||[],i=s.findIndex(t=>(t.name||"").trim().toLowerCase()===e);return i<0&&this.dbg("resolveGroup: subject group not found, defaulting to 0",{subjectIndex:t,subjectGroup:e,availableGroups:s.map(t=>t.name)}),i>=0?i:0},isAssigned(t,e,s){const i=!!this.study?.content?.study_data?.assignments?.[t]?.[e]?.[s];return i||0!==t||0!==e||0!==s||this.dbg("isAssigned=false example",{sectionIdx:t,visitIdx:e,groupIdx:s}),i},findBestEntry(t,e,s){const i=(this.entries||[]).filter(i=>i.subject_index===t&&i.visit_index===e&&i.group_index===s);if(!i.length)return null;const r=Number(this.selectedVersion),n=i.find(t=>Number(t.form_version)===r);if(n)return n;const a=i.filter(t=>Number(t.form_version)<=r).sort((t,e)=>Number(e.form_version)-Number(t.form_version))[0];return a||i.sort((t,e)=>Number(e.form_version)-Number(t.form_version))[0]},getValue(t,e,s,i){const r=this.resolveGroup(t),n=this.findBestEntry(t,e,r);if(!n||!n.data)return"";const a=n.data;if(!Array.isArray(a)){const t=this.dictRead(a,s,i);return null!=t?t:""}const o=Array.isArray(a)&&a[s]||[];return null!=o[i]?o[i]:""},isCellSkipped(t,e,s,i){const r=this.resolveGroup(t),n=this.findBestEntry(t,e,r);if(!n)return!1;const a=n.skipped_required_flags;return!(!Array.isArray(a)||!Array.isArray(a[s])||!0!==a[s][i])},cellClass(t,e,s,i){const r=this.resolveGroup(t),n=this.isAssigned(s,e,r),a=(n&&this.getValue(t,e,s,i),this.sections?.[s]?.fields?.[i]||{});(a.type||"").toLowerCase();return{"cell-skipped":this.isCellSkipped(t,e,s,i),"cell-unassigned":!n,"cell-empty-assigned":!1}},sortTable(t){this.sortConfig.key===t?this.sortConfig.direction="asc"===this.sortConfig.direction?"desc":"asc":this.sortConfig={key:t,direction:"asc"}},sortIcon(t){return this.sortConfig.key===t&&"desc"===this.sortConfig.direction?this.icons.toggleDown:this.icons.toggleUp},formatFileCell(t){const e=t=>{if(!t)return"";const e=String(t),s=e.split(/[\\/]/);return s[s.length-1]},s=t=>t.file_name||t.name||e(t.url)||e(t.file_path)||"";if(Array.isArray(t)){const i=t.map(t=>t&&"object"===typeof t?s(t):"string"===typeof t?e(t):"").filter(Boolean);return i.join(", ")}return t&&"object"===typeof t?s(t):"string"===typeof t?e(t):""},goFirst(){this.currentPage=1},goPrev(){this.currentPage>1&&this.currentPage--},goNext(){this.currentPage<this.totalPages&&this.currentPage++},goLast(){this.currentPage=this.totalPages},async exportCSV(){const t=await this.ensureAllEntriesForExport();this.downloadDelimited(t,"csv"),this.showExportMenu=!1},async exportExcel(){const t=await this.ensureAllEntriesForExport();this.downloadDelimited(t,"xls"),this.showExportMenu=!1},async ensureAllEntriesForExport(){const t=this.$route.params.id;let e=this.entries;if(!this.viewAll&&!this.canViewAll)try{const s=await P.A.get(`/forms/studies/${t}/data_entries?all=true&version=${this.selectedVersion}`,{headers:{Authorization:`Bearer ${this.token}`}}),i=Array.isArray(s.data)?{entries:s.data}:s.data||{};e=i.entries||[]}catch(r){console.error("Failed to fetch all entries for export, using current page only.",r)}const s=this.entries;this.entries=e;const i=[];return this.subjects.forEach((t,e)=>{const s=this.resolveGroup(e);this.visits.forEach((r,n)=>{const a={subjectId:t.id,visit:r.name};this.sections.forEach((t,i)=>{const r=this.isAssigned(i,n,s);t.fields.forEach((t,s)=>{let o="";if(r){const r=this.getValue(e,n,i,s),a=(t.type||"").toLowerCase();o="checkbox"===a?!0===r?"Yes":!1===r?"No":"":"file"===a?this.formatFileCell(r):null==r||""===r?"":r}a[`s${i}_f${s}`]=o})}),i.push(a)})}),this.entries=s,i},downloadDelimited(t,e){const s=t=>`"${String(t).replace(/"/g,'""')}"`,i=["Subject ID","Visit",...this.sections.flatMap((t,e)=>Array(this.fieldsPerSection[e]).fill(t.title))],r=["","",...this.sections.flatMap(t=>t.fields.map(t=>t.label||t.name||t.title))],n=[];n.push(i.map(s).join(",")),n.push(r.map(s).join(","));const a=t.filter(t=>{if(this.filters.subjectId&&!String(t.subjectId).toLowerCase().includes(this.filters.subjectId.toLowerCase()))return!1;if(this.filters.visit&&!String(t.visit).toLowerCase().includes(this.filters.visit.toLowerCase()))return!1;for(const e in this.filters){if("subjectId"===e||"visit"===e)continue;const s=this.filters[e];if(s&&!String(t[e]??"").toLowerCase().includes(String(s).toLowerCase()))return!1}return!0});a.forEach(t=>{const e=[t.subjectId,t.visit];this.sections.forEach((s,i)=>{s.fields.forEach((s,r)=>{e.push(t[`s${i}_f${r}`])})}),n.push(e.map(s).join(","))});const o="xls"===e?"application/vnd.ms-excel":"text/csv",l="xls"===e?"xls":"csv",d=new Blob([n.join("\r\n")],{type:o}),c=URL.createObjectURL(d),u=document.createElement("a");u.href=c,u.download=`${this.study?.metadata?.study_name||"study"}_v${this.selectedVersion}_data.${l}`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(c)}}},D=s(6262);const K=(0,D.A)(F,[["render",V],["__scopeId","data-v-670e0aad"]]);var X=K},8646:function(t,e,s){var i=s(9565),r=s(8551),n=s(1767),a=s(851);t.exports=function(t,e){e&&"string"===typeof t||r(t);var s=a(t);return n(r(void 0!==s?i(s,t):t))}}}]);
//# sourceMappingURL=535.63d468b2.js.map